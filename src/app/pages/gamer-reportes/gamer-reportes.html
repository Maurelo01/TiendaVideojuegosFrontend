<div class="container mt-5 mb-5">
    
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h2 class="texto-nordico fw-bold m-0 mt-4">
            <i class="bi bi-bar-chart-fill me-2"></i>Mis Estadísticas
        </h2>
        <button class="btn btn-outline-secondary rounded-3" routerLink="/mi-perfil">
            <i class="bi bi-arrow-left me-1"></i> Volver al Perfil
        </button>
    </div>

    <ul class="nav nav-pills mb-4 gap-2" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-3 fw-bold px-4" 
                [ngClass]="vistaActual === 'analisis' ? 'bg-nordico text-white shadow' : 'bg-white text-secondary border'"
                (click)="cambiarVista('analisis')">
                <i class="bi bi-pie-chart me-1"></i> Análisis de Biblioteca
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-3 fw-bold px-4" 
                [ngClass]="vistaActual === 'familiar' ? 'bg-nordico text-white shadow' : 'bg-white text-secondary border'"
                (click)="cambiarVista('familiar')">
                <i class="bi bi-people me-1"></i> Uso Familiar
            </button>
        </li>
    </ul>

    <div *ngIf="cargando" class="text-center py-5">
        <div class="spinner-border text-nordico-claro" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="text-muted mt-2">Analizando datos...</p>
    </div>

    <div *ngIf="!cargando && reporte && vistaActual === 'analisis'" class="animate__animated animate__fadeIn">
        <div class="row g-4">
            
            <div class="col-lg-6">
                <div class="card tarjeta-nordica h-100 p-3">
                    <div class="card-body">
                        <h5 class="texto-nordico fw-bold mb-4">
                            <i class="bi bi-heart-fill text-danger me-2"></i>Categorías Favoritas
                        </h5>
                        
                        <div *ngIf="reporte.categoriasFavoritas.length === 0" class="text-center text-muted py-5 opacity-50">
                            <i class="bi bi-controller fs-1 mb-2"></i>
                            <p>No tienes suficientes juegos para generar este gráfico.</p>
                        </div>

                        <div *ngFor="let cat of reporte.categoriasFavoritas" class="mb-4">
                            <div class="d-flex justify-content-between small mb-2 text-muted fw-bold text-uppercase">
                                <span>{{ cat.categoria }}</span>
                                <span>{{ cat.cantidad }} juegos</span>
                            </div>
                            <div class="progress rounded-pill bg-light" style="height: 12px;">
                                <div class="progress-bar rounded-pill" role="progressbar" 
                                     style="background-color: var(--azul-nordico-claro);"
                                     [style.width.%]="(cat.cantidad * 10) + 10">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card tarjeta-nordica h-100 p-3">
                    <div class="card-body">
                        <h5 class="texto-nordico fw-bold mb-4">
                            <i class="bi bi-star-half me-2"></i>Mi Opinión vs. Comunidad
                        </h5>
                        
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="text-secondary small text-uppercase">
                                    <tr>
                                        <th class="border-0">Juego</th>
                                        <th class="text-center border-0">Yo</th>
                                        <th class="text-center border-0">Global</th>
                                        <th class="text-center border-0">Dif.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of reporte.comparativaCalificaciones">
                                        <td class="fw-bold text-dark">{{ item.tituloJuego }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-light text-dark border">{{ item.miCalificacion }}</span>
                                        </td>
                                        <td class="text-center text-muted">{{ item.promedioComunidad | number:'1.1-1' }}</td>
                                        <td class="text-center">
                                            <span class="badge rounded-pill" 
                                                [ngClass]="{
                                                    'bg-success': item.miCalificacion > item.promedioComunidad,
                                                    'bg-danger': item.miCalificacion < item.promedioComunidad,
                                                    'bg-secondary': item.miCalificacion === item.promedioComunidad
                                                }">
                                                {{ (item.miCalificacion - item.promedioComunidad) > 0 ? '+' : '' }}{{ (item.miCalificacion - item.promedioComunidad) | number:'1.1-1' }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr *ngIf="reporte.comparativaCalificaciones.length === 0">
                                        <td colspan="4" class="text-center py-5 text-muted small">
                                            Aún no has calificado ningún juego.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="!cargando && vistaActual === 'familiar'" class="animate__animated animate__fadeIn">
        <div class="card tarjeta-nordica p-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="texto-nordico fw-bold m-0">
                        <i class="bi bi-people-fill me-2"></i>Historial de Préstamos Activos
                    </h5>
                    <span class="badge bg-light text-muted border">{{ usoFamiliar.length }} registros</span>
                </div>

                <div class="table-responsive rounded-3 border">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-uppercase small text-muted">
                            <tr>
                                <th class="py-3 ps-3">Juego Prestado</th>
                                <th class="py-3">Propietario</th>
                                <th class="py-3 text-center">Veces Instalado</th>
                                <th class="py-3 text-center">Calidad Global</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of usoFamiliar">
                                <td class="ps-3 fw-bold text-dark">{{ item.tituloJuego }}</td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="rounded-circle bg-nordico text-white d-flex justify-content-center align-items-center" 
                                             style="width: 30px; height: 30px; font-size: 0.8rem;">
                                            {{ item.nombrePropietario.charAt(0) }}
                                        </div>
                                        <span>{{ item.nombrePropietario }}</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-white text-dark border shadow-sm px-3 py-2 rounded-pill">
                                        <i class="bi bi-download me-1"></i> {{ item.vecesInstalado }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span *ngIf="item.promedioComunidad > 0" class="text-warning fw-bold">
                                        <i class="bi bi-star-fill"></i> {{ item.promedioComunidad | number:'1.1-1' }}
                                    </span>
                                    <span *ngIf="item.promedioComunidad === 0" class="text-muted small fst-italic">
                                        Sin calificación
                                    </span>
                                </td>
                            </tr>
                            <tr *ngIf="usoFamiliar.length === 0">
                                <td colspan="4" class="text-center py-5 text-muted">
                                    <div class="opacity-50 mb-3">
                                        <i class="bi bi-emoji-neutral fs-1"></i>
                                    </div>
                                    <h6 class="fw-bold">Sin actividad reciente</h6>
                                    <p class="small mb-0">No has pedido prestado ningún juego de tu grupo familiar todavía.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>