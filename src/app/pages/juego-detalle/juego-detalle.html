<div class="container mt-5 mb-5" *ngIf="juego">
    
    <div class="card tarjeta-nordica overflow-hidden mb-5">
        <div class="row g-0">
            <div class="col-md-5 col-lg-4 bg-light position-relative">
                <img [src]="juego.imagen ? 'data:image/jpeg;base64,' + juego.imagen : 'https://placehold.co/400x600'"
                    class="w-100 h-100 object-fit-cover" 
                    style="min-height: 400px;" 
                    alt="{{ juego.titulo }}">
                
                <div class="position-absolute top-0 start-0 m-3">
                    <span class="badge bg-dark bg-opacity-75 backdrop-blur shadow-sm">
                        {{ juego.estado }}
                    </span>
                </div>
            </div>

            <div class="col-md-7 col-lg-8">
                <div class="card-body p-4 p-lg-5 d-flex flex-column h-100">
                    
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <small class="text-muted text-uppercase fw-bold ls-1">{{ juego.nombreEmpresa || 'Desarrollador Independiente' }}</small>
                            <h1 class="texto-nordico fw-bold display-6 mb-2">{{ juego.titulo }}</h1>
                        </div>
                        <div class="text-end">
                            <span class="badge border text-dark rounded-pill px-3 mb-2">{{ juego.clasificacionEdad }}</span>
                        </div>
                    </div>

                    <div class="mb-4 d-flex align-items-center gap-3">
                        <h2 class="text-nordico-claro fw-bold m-0">${{ juego.precio }}</h2>
                        <span *ngIf="tieneElJuego" class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill">
                            <i class="bi bi-check-circle-fill me-1"></i> En tu biblioteca
                        </span>
                    </div>

                    <p class="text-secondary flex-grow-1">{{ juego.descripcion }}</p>

                    <div class="bg-light rounded-3 p-3 mb-4 border border-dashed">
                        <h6 class="texto-nordico fw-bold small mb-1"><i class="bi bi-cpu me-1"></i> Requisitos del Sistema</h6>
                        <small class="text-muted">{{ juego.recursosMinimos }}</small>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary rounded-3 px-4" routerLink="/home">
                            <i class="bi bi-arrow-left me-1"></i> Volver
                        </button>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="multimedia && multimedia.length > 0" class="mb-5 animate__animated animate__fadeIn">
        <h4 class="texto-nordico fw-bold mb-4 border-bottom pb-2">
            <i class="bi bi-images me-2"></i>Galería
        </h4>

        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
            <div class="col" *ngFor="let media of multimedia">
                <div class="card tarjeta-nordica h-100 overflow-hidden position-relative group-hover-effect">
                    <img [src]="'data:image/jpeg;base64,' + media.contenido"
                        class="card-img-top object-fit-cover w-100 h-100" 
                        style="height: 200px; cursor: pointer; transition: transform 0.3s;"
                        alt="Media" data-bs-toggle="modal"
                        [attr.data-bs-target]="'#modalMedia' + media.idMedia"
                        onmouseover="this.style.transform='scale(1.05)'" 
                        onmouseout="this.style.transform='scale(1)'">
                    
                    <div class="position-absolute bottom-0 end-0 m-2">
                        <span class="badge bg-dark bg-opacity-50"><i class="bi bi-arrows-fullscreen"></i></span>
                    </div>
                </div>

                <div class="modal fade" [id]="'modalMedia' + media.idMedia" tabindex="-1" aria-hidden="true" style="background: rgba(0,0,0,0.9)">
                    <div class="modal-dialog modal-dialog-centered modal-xl">
                        <div class="modal-content bg-transparent border-0">
                            <div class="modal-body p-0 text-center position-relative">
                                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3"
                                    data-bs-dismiss="modal" aria-label="Close"></button>
                                <img [src]="'data:image/jpeg;base64,' + media.contenido" class="img-fluid rounded shadow-lg" style="max-height: 90vh;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h4 class="texto-nordico fw-bold mb-4 border-bottom pb-2">
                <i class="bi bi-chat-square-text me-2"></i>Reseñas de la Comunidad
            </h4>

            <div *ngIf="tieneElJuego" id="form-comentario" class="card tarjeta-nordica mb-5 p-4 border-start border-4"
                [ngClass]="(idComentarioAresponder || nuevoComentario.idComentarioPrincipal) ? 'border-info' : 'border-primary'">
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0" [ngClass]="(idComentarioAresponder) ? 'text-info' : 'texto-nordico'">
                        <span *ngIf="!editandoComentarioId && !idComentarioAresponder">Escribir Reseña</span>
                        <span *ngIf="idComentarioAresponder">Respondiendo a {{ nombreUsuarioAresponder }}</span>
                        <span *ngIf="editandoComentarioId">Editando tu publicación</span>
                    </h5>
                    <i class="bi fs-4 text-muted" [ngClass]="(idComentarioAresponder) ? 'bi-reply-fill' : 'bi-pencil-square'"></i>
                </div>

                <form (ngSubmit)="enviarComentario()">
                    <div class="mb-3" *ngIf="!idComentarioAresponder && !nuevoComentario.idComentarioPrincipal">
                        <label class="form-label small fw-bold text-secondary">Tu Calificación</label>
                        <div class="input-group" style="max-width: 200px;">
                            <span class="input-group-text bg-warning text-white border-0"><i class="bi bi-star-fill"></i></span>
                            <select class="form-select bg-light border-0" [(ngModel)]="nuevoComentario.calificacion" name="calif">
                                <option [value]="5">5 - Perfecto</option>
                                <option [value]="4">4 - Bueno</option>
                                <option [value]="3">3 - Normal</option>
                                <option [value]="2">2 - Malo</option>
                                <option [value]="1">1 - Horrible</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <textarea class="form-control bg-light border-0 rounded-3 p-3" rows="3" 
                            [(ngModel)]="nuevoComentario.texto" name="texto"
                            placeholder="Comparte tu opinión con la comunidad..." required></textarea>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <button *ngIf="editandoComentarioId || idComentarioAresponder" type="button"
                            class="btn btn-link text-muted text-decoration-none"
                            (click)="editandoComentarioId ? cancelarEdicion() : cancelarRespuesta()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn px-4 rounded-3 fw-bold"
                            [ngClass]="(idComentarioAresponder || nuevoComentario.idComentarioPrincipal) ? 'boton-acento' : 'boton-nordico'">
                            <i class="bi bi-send-fill me-1"></i>
                            {{ editandoComentarioId ? 'Actualizar' : 'Publicar' }}
                        </button>
                    </div>
                </form>
            </div>

            <div *ngIf="!tieneElJuego && usuarioActual?.rol === 'GAMER'" class="alert alert-light border shadow-sm rounded-3 text-center py-4">
                <i class="bi bi-lock-fill text-muted fs-4 d-block mb-2"></i>
                <span class="text-muted">Debes adquirir este juego para escribir una reseña.</span>
            </div>

            <ng-template #comentarioTemplate let-lista>
                <div *ngFor="let c of lista" class="mb-3 animate__animated animate__fadeIn">
                    
                    <div class="card border-0 bg-white shadow-sm rounded-3 overflow-hidden position-relative"
                        [ngClass]="{'ms-4 ms-md-5 border-start border-3 border-info bg-light bg-opacity-25': c.idComentarioPrincipal}">
                        
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle bg-nordico text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 0.8rem;">
                                        {{ c.nicknameGamer.charAt(0) | uppercase }}
                                    </div>
                                    <div>
                                        <h6 class="fw-bold mb-0 text-dark">
                                            {{ c.nicknameGamer }}
                                            <span *ngIf="c.esMio" class="badge bg-nordico text-white ms-1" style="font-size: 0.6rem">Tú</span>
                                        </h6>
                                        <small class="text-muted" style="font-size: 0.75rem;">{{ c.fecha | date:'mediumDate' }}</small>
                                    </div>
                                </div>

                                <div *ngIf="c.calificacion > 0" class="text-warning small">
                                    <i class="bi bi-star-fill" *ngFor="let s of generarEstrellas(c.calificacion)"></i>
                                    <i class="bi bi-star text-muted opacity-25" *ngFor="let s of generarEstrellasVacias(c.calificacion)"></i>
                                </div>
                            </div>

                            <div class="mt-2">
                                <div *ngIf="c.oculto && !esModerador" class="alert alert-secondary py-2 px-3 small fst-italic mb-0">
                                    <i class="bi bi-eye-slash-fill me-2"></i> Comentario ocultado por moderación.
                                </div>
                                
                                <div *ngIf="!c.oculto || esModerador">
                                    <div *ngIf="c.oculto && esModerador" class="badge bg-danger mb-2">
                                        <i class="bi bi-shield-lock-fill"></i> Visible solo para moderadores
                                    </div>
                                    <p class="text-secondary mb-0" style="white-space: pre-wrap;">{{ c.texto }}</p>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end gap-3 mt-3 pt-2 border-top border-light">
                                <button *ngIf="esModerador" class="btn btn-sm py-0 fw-bold"
                                    [ngClass]="c.oculto ? 'text-success' : 'text-warning'"
                                    (click)="herramientaModeracion(c)">
                                    <i class="bi" [ngClass]="c.oculto ? 'bi-eye' : 'bi-eye-slash'"></i>
                                    {{ c.oculto ? 'Restaurar' : 'Ocultar' }}
                                </button>

                                <button *ngIf="tieneElJuego && !c.oculto"
                                    class="btn btn-sm py-0 text-nordico-claro fw-bold text-decoration-none" 
                                    (click)="responderComentario(c)">
                                    <i class="bi bi-reply-fill"></i> Responder
                                </button>

                                <ng-container *ngIf="c.esMio">
                                    <button class="btn btn-sm py-0 text-secondary fw-bold text-decoration-none" (click)="iniciarEdicion(c)">
                                        <i class="bi bi-pencil"></i> Editar
                                    </button>
                                    <button class="btn btn-sm py-0 text-danger fw-bold text-decoration-none" (click)="borrarComentario(c.idComentario!)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </ng-container>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="c.respuestas && c.respuestas.length > 0">
                        <ng-container *ngTemplateOutlet="comentarioTemplate; context:{ $implicit: c.respuestas }">
                        </ng-container>
                    </div>
                </div>
            </ng-template>

            <div *ngIf="comentarios.length > 0; else noComentarios">
                <ng-container *ngTemplateOutlet="comentarioTemplate; context:{ $implicit: comentarios }">
                </ng-container>
            </div>

            <ng-template #noComentarios>
                <div class="text-center py-5 card tarjeta-nordica border-dashed">
                    <div class="card-body opacity-50">
                        <i class="bi bi-chat-left-quote fs-1 d-block mb-3"></i>
                        <h5>Aún no hay reseñas</h5>
                        <p>Sé el primero en compartir tu experiencia con este juego.</p>
                    </div>
                </div>
            </ng-template>

        </div>
    </div>
</div>