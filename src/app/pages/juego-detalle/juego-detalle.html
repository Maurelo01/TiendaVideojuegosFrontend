<div class="container mt-5 mb-5" *ngIf="juego">
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow border-0">
                <img [src]="juego.imagen ? 'data:image/jpeg;base64,' + juego.imagen : 'https://placehold.co/400x600'"
                    class="card-img-top object-fit-cover rounded" alt="{{ juego.titulo }}">
            </div>
        </div>

        <div class="col-md-8">
            <h1 class="fw-bold display-5 text-dark mb-1">{{ juego.titulo }}</h1>
            <p class="text-muted fs-5 mb-3">
                Desarrollado por: <span class="fw-bold text-primary">{{ juego.nombreEmpresa || 'Empresa Asociada' }}</span>
            </p>

            <div class="mb-4">
                <span class="badge bg-primary fs-6 me-2">{{ juego.clasificacionEdad }}</span>
                <span class="badge bg-dark fs-6 me-2">{{ juego.estado }}</span>
                <span class="badge bg-success fs-6" *ngIf="tieneElJuego">
                    <i class="bi bi-check-circle-fill"></i> En tu biblioteca
                </span>
            </div>

            <h2 class="text-success fw-bold mb-3">${{ juego.precio }}</h2>
            <p class="lead text-secondary">{{ juego.descripcion }}</p>

            <hr class="my-4">

            <div class="card bg-light border-0 p-3 mb-4">
                <h6 class="fw-bold"><i class="bi bi-cpu-fill"></i> Requisitos del Sistema</h6>
                <p class="mb-0 small text-muted">{{ juego.recursosMinimos }}</p>
            </div>

            <button class="btn btn-outline-secondary" routerLink="/home">
                <i class="bi bi-arrow-left"></i> Volver al Catálogo
            </button>
        </div>
    </div>

    <div *ngIf="multimedia && multimedia.length > 0" class="mb-5 animate__animated animate__fadeIn">
        <h3 class="border-bottom pb-2 mb-4 text-secondary">
            <i class="bi bi-images"></i> Galería y Contenido Extra
        </h3>
        
        <div class="row g-3">
            <div class="col-md-4 col-sm-6" *ngFor="let media of multimedia">
                <div class="card border-0 shadow-sm h-100 overflow-hidden">
                    <img [src]="'data:image/jpeg;base64,' + media.contenido" 
                         class="card-img-top object-fit-cover hover-zoom" 
                         style="height: 220px; cursor: pointer;"
                         alt="Captura del juego"
                         data-bs-toggle="modal" 
                         [attr.data-bs-target]="'#modalMedia' + media.idMedia">
                </div>

                <div class="modal fade" 
                     [id]="'modalMedia' + media.idMedia" 
                     tabindex="-1" 
                     aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content bg-transparent border-0">
                            <div class="modal-body p-0 position-relative text-center">
                                <button type="button" 
                                        class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                                        data-bs-dismiss="modal" 
                                        aria-label="Close">
                                </button>
                                <img [src]="'data:image/jpeg;base64,' + media.contenido" 
                                     class="img-fluid rounded shadow-lg">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h3 class="border-bottom pb-2 mb-4">
                <i class="bi bi-chat-square-text-fill"></i> Reseñas de la Comunidad
            </h3>

            <div *ngIf="tieneElJuego" id="form-comentario" class="card mb-5 border-primary shadow-sm">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-pen-fill me-2"></i>
                    {{ editandoComentarioId ? 'Editar tu reseña' : '¡Comparte tu opinión!' }}
                </div>
                <div class="card-body">
                    <form (ngSubmit)="enviarComentario()">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Calificación</label>
                            <select class="form-select w-auto" [(ngModel)]="nuevoComentario.calificacion" name="calif">
                                <option [value]="5">⭐⭐⭐⭐⭐ Perfecto</option>
                                <option [value]="4">⭐⭐⭐⭐ Muy Bueno</option>
                                <option [value]="3">⭐⭐⭐ Normal</option>
                                <option [value]="2">⭐⭐ Malo</option>
                                <option [value]="1">⭐ Terrible</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tu Reseña</label>
                            <textarea class="form-control" rows="3" [(ngModel)]="nuevoComentario.texto" name="texto"
                                placeholder="¿Qué te pareció el juego?" required></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success fw-bold">
                                <i class="bi" [ngClass]="editandoComentarioId ? 'bi-arrow-repeat' : 'bi-send-fill'"></i>
                                {{ editandoComentarioId ? 'Actualizar Reseña' : 'Publicar Reseña' }}
                            </button>
                            <button *ngIf="editandoComentarioId" type="button" class="btn btn-secondary"
                                (click)="cancelarEdicion()">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div *ngIf="!tieneElJuego && usuarioActual?.rol === 'GAMER'" class="alert alert-info shadow-sm">
                <i class="bi bi-info-circle-fill me-2"></i>
                Adquiere este juego para poder escribir una reseña.
            </div>

            <div *ngIf="comentarios.length === 0" class="text-center py-5 text-muted bg-light rounded">
                <i class="bi bi-chat-quote fs-1"></i>
                <p class="mt-3 fs-5">Aún no hay reseñas. ¡Sé el primero en opinar!</p>
            </div>

            <div class="card mb-3 border-0 shadow-sm" *ngFor="let c of comentarios">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-bold mb-1" [ngClass]="c.esMio ? 'text-success' : 'text-primary'">
                                <a [routerLink]="['/usuario', c.idGamer]" 
                                   class="text-decoration-none text-reset hover-underline cursor-pointer"
                                   title="Ver perfil de {{ c.nicknameGamer }}">
                                    <i class="bi bi-person-circle"></i> {{ c.nicknameGamer }}
                                </a>
                                <span *ngIf="c.esMio" class="badge bg-success ms-1" style="font-size: 0.7em">Tú</span>
                            </h6>
                            
                            <div class="text-warning small mb-2">
                                <i class="bi bi-star-fill" *ngFor="let s of generarEstrellas(c.calificacion)"></i>
                                <i class="bi bi-star" *ngFor="let s of generarEstrellasVacias(c.calificacion)"></i>
                                
                                <span class="text-muted ms-2 fw-bold" style="font-size: 0.9em;">
                                    ({{ c.calificacion }} / 5)
                                </span>
                            </div>
                        </div>
                        <small class="text-muted">{{ c.fecha | date:'mediumDate' }}</small>
                    </div>
                    
                    <p class="card-text mt-1 ms-3 border-start border-3 border-secondary ps-3">
                        {{ c.texto }}
                    </p>
                    
                    <div *ngIf="c.esMio" class="text-end border-top pt-2 mt-2">
                        <button class="btn btn-sm btn-link text-decoration-none fw-bold" (click)="iniciarEdicion(c)">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-link text-danger text-decoration-none fw-bold" 
                            (click)="borrarComentario(c.idComentario!)">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>