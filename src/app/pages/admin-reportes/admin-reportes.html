<div class="container mt-4 mb-5">

    <button class="btn btn-outline-secondary mb-3 mt-4" routerLink="/home">
        <i class="bi bi-arrow-left"></i> Volver al Inicio
    </button>

    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
        <h2 class="fw-bold text-dark m-0">
            <i class="bi bi-graph-up-arrow text-primary"></i> Panel de Reportes
        </h2>

        <div class="btn-group shadow-sm" role="group">
            <button type="button" class="btn"
                [ngClass]="vistaActual === 'global' ? 'btn-primary' : 'btn-outline-primary'" (click)="generarReporte()">
                <i class="bi bi-cash-stack"></i> Finanzas Globales
            </button>
            <button type="button" class="btn"
                [ngClass]="vistaActual === 'ranking' ? 'btn-primary' : 'btn-outline-primary'"
                (click)="cargarRankings()">
                <i class="bi bi-trophy-fill"></i> Ranking Usuarios
            </button>
            <button type="button" class="btn" [ngClass]="vistaActual === 'top' ? 'btn-primary' : 'btn-outline-primary'"
                (click)="cargarTopJuegos()">
                <i class="bi bi-star-fill"></i> Top Ventas y Calidad
            </button>
        </div>
    </div>

    <div *ngIf="vistaActual === 'global'" class="animate__animated animate__fadeIn">

        <div class="card p-4 shadow-sm mb-4 border-0 bg-light">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold text-secondary">Desde</label>
                    <input type="date" class="form-control" [(ngModel)]="fechaInicio">
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold text-secondary">Hasta</label>
                    <input type="date" class="form-control" [(ngModel)]="fechaFin">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" (click)="generarReporte()">
                        <i class="bi bi-funnel-fill"></i> Filtrar
                    </button>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" (click)="limpiarFiltros()">
                        <i class="bi bi-arrow-counterclockwise"></i> Limpiar
                    </button>
                </div>

            </div>
        </div>

        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-danger shadow-sm" (click)="exportarPDF()">
                <i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF
            </button>
        </div>

        <div class="card shadow border-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th class="py-3 ps-4">Empresa</th>
                            <th class="text-center">Ventas Totales</th>
                            <th class="text-end">Ingresos Brutos</th>
                            <th class="text-end">Comisión</th>
                            <th class="text-end pe-4">Ganancia Neta Empresa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of reporte">
                            <td class="ps-4 fw-bold">{{ item.nombreEmpresa }}</td>
                            <td class="text-center">
                                <span class="badge bg-secondary rounded-pill">{{ item.totalVentas }}</span>
                            </td>
                            <td class="text-end text-primary">${{ item.totalIngresos | number:'1.2-2' }}</td>
                            <td class="text-end text-success fw-bold">${{ item.gananciaPlataforma | number:'1.2-2' }}
                            </td>
                            <td class="text-end text-muted pe-4">${{ item.gananciaEmpresa | number:'1.2-2' }}</td>
                        </tr>
                        <tr *ngIf="reporte.length === 0">
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                                No hay datos financieros para el rango seleccionado.
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="table-light fw-bold border-top" *ngIf="reporte.length > 0">
                        <tr>
                            <td class="text-end ps-4 text-uppercase text-secondary">Totales Globales:</td>
                            <td class="text-center">-</td>
                            <td class="text-end">${{ totalGlobalIngresos | number:'1.2-2' }}</td>
                            <td class="text-end text-success fs-5">${{ totalGlobalGanancia | number:'1.2-2' }}</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div *ngIf="vistaActual === 'ranking'" class="animate__animated animate__fadeIn">
        <div class="row g-4">

            <div class="col-lg-6">
                <div class="card shadow border-0 h-100">
                    <div
                        class="card-header bg-success text-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-bag-check-fill"></i> Top Compradores</h5>
                        <small class="opacity-75">Usuarios que más invierten</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="text-center ps-3">#</th>
                                    <th>Gamer</th>
                                    <th class="text-center">Juegos</th>
                                    <th class="text-end pe-3">Total Gastado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let u of rankingCompradores; let i = index">
                                    <td class="text-center fw-bold text-muted ps-3">{{ i + 1 }}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="bg-success bg-opacity-10 text-success rounded-circle d-flex align-items-center justify-content-center"
                                                style="width: 32px; height: 32px;">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                            <span class="fw-bold text-dark">{{ u.nickname }}</span>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-light text-dark border">{{ u.cantidad }}</span>
                                    </td>
                                    <td class="text-end text-success fw-bold pe-3">
                                        ${{ u.totalGastado | number:'1.2-2' }}
                                    </td>
                                </tr>
                                <tr *ngIf="rankingCompradores.length === 0">
                                    <td colspan="4" class="text-center py-5 text-muted">Sin datos registrados aún.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow border-0 h-100">
                    <div class="card-header bg-info text-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-chat-quote-fill"></i> Críticos Top</h5>
                        <small class="opacity-75">Usuarios más participativos</small>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light text-secondary small text-uppercase">
                                <tr>
                                    <th class="text-center ps-3">#</th>
                                    <th>Gamer</th>
                                    <th class="text-center pe-3">Reseñas Escritas</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let u of rankingReviewers; let i = index">
                                    <td class="text-center fw-bold text-muted ps-3">{{ i + 1 }}</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="bg-info bg-opacity-10 text-info rounded-circle d-flex align-items-center justify-content-center"
                                                style="width: 32px; height: 32px;">
                                                <i class="bi bi-pen-fill"></i>
                                            </div>
                                            <span class="fw-bold text-dark">{{ u.nickname }}</span>
                                        </div>
                                    </td>
                                    <td class="text-center pe-3">
                                        <span class="badge bg-info text-dark fs-6 rounded-pill px-3">{{ u.cantidad
                                            }}</span>
                                    </td>
                                </tr>
                                <tr *ngIf="rankingReviewers.length === 0">
                                    <td colspan="3" class="text-center py-5 text-muted">Sin datos registrados aún.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="vistaActual === 'top'" class="animate__animated animate__fadeIn">

        <div class="card p-3 mb-3 bg-light border-0 shadow-sm">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-secondary">Categoría</label>
                    <select class="form-select" [(ngModel)]="filtroCategoria" (change)="cargarTopJuegos()">
                        <option [value]="0">Todas</option>
                        <option *ngFor="let c of categorias" [value]="c.idCategoria">{{ c.nombreCategoria }}</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold text-secondary">Clasificación Edad</label>
                    <select class="form-select" [(ngModel)]="filtroEdad" (change)="cargarTopJuegos()">
                        <option value="">Todas</option>
                        <option value="E">E - Todo Público</option>
                        <option value="T">T - Adolescentes</option>
                        <option value="M">M - Adultos</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary w-100"
                        (click)="filtroCategoria=0; filtroEdad=''; cargarTopJuegos()">
                        <i class="bi bi-arrow-counterclockwise"></i> Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow border-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="ps-4 py-3">Juego</th>
                            <th>Empresa</th>
                            <th class="text-center">Ventas</th>
                            <th class="text-center">Calif. Promedio</th>
                            <th class="text-center pe-4">Puntaje Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let j of topJuegos">
                            <td class="ps-4 fw-bold text-primary">{{ j.titulo }}</td>
                            <td>{{ j.nombreEmpresa }}</td>
                            <td class="text-center">{{ j.totalVentas }}</td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark border">
                                    <i class="bi bi-star-fill"></i> {{ j.promedioCalificacion | number:'1.1-1' }}
                                </span>
                            </td>
                            <td class="text-center pe-4 fw-bold text-success fs-5">{{ j.puntajeBalance | number:'1.1-1'}}</td>
                        </tr>
                        <tr *ngIf="topJuegos.length === 0">
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="bi bi-search fs-1 d-block mb-2 opacity-50"></i>
                                No se encontraron juegos con estos filtros.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>